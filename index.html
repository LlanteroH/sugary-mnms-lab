<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Sugary M&Ms — Interactive Lab (No-CDN)</title>
<style>
  :root{
    --ink:#0f172a;--muted:#64748b;--line:#e2e8f0;--card:#fff;--bg0:#f8fafc;--bg1:#f1f5f9;
    --green:#10b981;--green-50:#ecfdf5;--amber:#f59e0b;
  }
  html,body{height:100%}
  body{margin:0;background:linear-gradient(var(--bg0),var(--bg1));
       font:14px/1.4 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;color:var(--ink)}
  .container{max-width:1200px;margin:0 auto;padding:16px}
  h1{font-size:28px;line-height:1.2;margin:0 0 8px 0;font-weight:800}
  .row{display:grid;gap:16px}
  @media(min-width:980px){.row-12{grid-template-columns:3fr 9fr}.row-2{grid-template-columns:1fr 1fr}.grid3{grid-template-columns:repeat(3,minmax(0,1fr))}}
  .card{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:12px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
  .btn{background:#0f172a;color:#fff;border:none;border-radius:12px;padding:8px 12px;cursor:pointer}
  .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--line);background:#f1f5f9;border-radius:12px;padding:6px 10px;cursor:grab;user-select:none}
  .tiny{font-size:12px;color:var(--muted)}
  .list{display:grid;gap:8px}
  .flex{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .grid3{display:grid;gap:12px}
  .notice{position:fixed;left:50%;transform:translateX(-50%);bottom:16px;background:#0f172a;color:#fff;padding:8px 12px;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.25);display:none}
  .circle{width:32px;height:32px;border-radius:999px;border:1px solid #cbd5e1;display:inline-block;box-shadow:0 1px 2px rgba(0,0,0,.05);cursor:grab}
  .board{background:#f8fafc}
  .slot{border:1px dashed var(--line);border-radius:12px;padding:8px;min-height:196px}
  .title{font-weight:700;margin:0 0 6px 0}
  .steps li{border:1px solid var(--line);border-radius:12px;padding:10px;display:flex;gap:8px;align-items:start;background:#fff}
  .steps .n{width:20px;height:20px;display:inline-flex;align-items:center;justify-content:center;border-radius:999px;font-size:12px;font-weight:700;background:#e2e8f0;color:#334155;margin-top:2px}
  .steps .ok{background:var(--green);color:#fff}
  .steps .done{background:var(--green-50);border-color:#34d399}
  textarea{width:100%;min-height:84px;padding:8px;border-radius:12px;border:1px solid var(--line);background:#f8fafc;resize:vertical}
  .badge{font-size:11px;padding:2px 6px;border-radius:8px}
  .badge-amber{background:#fde68a;color:#92400e;border:1px solid var(--amber)}
  .cupVis,.plateVis{display:grid;place-items:center;border:1px solid var(--line);border-radius:12px;background:#fff}
  .cupVis{height:120px}
  .plateVis{height:256px}
  .attached{display:inline-flex;align-items:center;gap:6px;margin-top:6px}
  .trayZone{border:1px dashed #cbd5e1;border-radius:12px;padding:6px;background:#fff}
  .ghost{opacity:.6}
</style>
</head>
<body>
  <div class="container">
    <header class="row" style="grid-template-columns:1fr auto;align-items:flex-start;gap:12px">
      <div>
        <h1>Sugary M&Ms — Interactive Lab</h1>
        <p class="tiny">Drag & drop to follow the procedure, then observe how dye from an M&amp;M spreads in different sugar concentrations.</p>
      </div>
      <div class="flex">
        <label class="tiny">Time speed</label>
        <input id="speed" type="range" min="1" max="30" step="1" value="10" style="width:160px">
        <span id="speedLabel" class="tiny" style="width:28px;text-align:right">10×</span>
        <button id="resetAll" class="btn">Reset</button>
      </div>
    </header>

    <ol id="steps" class="steps grid3" style="margin:16px 0"></ol>

    <section class="row row-12" style="margin-top:16px">
      <div>
        <div class="card">
          <h3 class="title">Tools</h3>
          <p class="tiny">Drag these onto cups/plates.</p>
          <div class="flex">
            <div class="pill" draggable="true" id="tool-water" title="Drag to add ¼ cup water to a cup">Water pitcher (¼ cup)</div>
            <div class="pill" draggable="true" id="tool-sugar" title="Drag to add 1 tsp sugar to a cup">Sugar spoon (1 tsp)</div>
          </div>
          <div style="margin-top:10px">
            <h4 class="tiny" style="font-size:13px;margin:0 0 6px 0">M&amp;Ms</h4>
            <div id="mmTray" class="flex"></div>
          </div>
        </div>

        <div class="card" style="margin-top:16px">
          <h3 class="title">Labels</h3>
          <p class="tiny">Drag onto cups and plates, or drag an attached label back into the tray to reassign.</p>
          <div id="labelTray" class="list trayZone"></div>
        </div>

        <div class="card" style="margin-top:16px">
          <h3 class="title">Student Notebook</h3>
          <div class="list">
            <div>
              <label class="tiny">Prediction (before adding M&amp;Ms)</label>
              <textarea id="pred"></textarea>
            </div>
            <div>
              <label class="tiny">Observations</label>
              <textarea id="obs"></textarea>
            </div>
            <div>
              <label class="tiny">Explanation (CER)</label>
              <textarea id="exp"></textarea>
            </div>
          </div>
        </div>
      </div>

      <div class="row row-2">
        <div class="card board">
          <h3 class="title">Cups</h3>
          <div id="cups" class="grid3"></div>
        </div>
        <div class="card board">
          <h3 class="title">Plates</h3>
          <div id="plates" class="grid3"></div>
        </div>
      </div>
    </section>
  </div>

  <div id="toast" class="notice"></div>

<script>
/* ----------------------------- State ----------------------------- */
const LABELS = [
  { id:"no",   text:"No sugar",   sugarTeaspoons:0 },
  { id:"1tsp", text:"1 tsp sugar",sugarTeaspoons:1 },
  { id:"3tsp", text:"3 tsp sugar",sugarTeaspoons:3 },
];
const MM = [
  { id:"red", rgb:[220,38,38] }, { id:"blue", rgb:[37,99,235] }, { id:"green", rgb:[16,185,129] },
  { id:"yellow", rgb:[234,179,8] }, { id:"orange", rgb:[249,115,22] }, { id:"brown", rgb:[87,55,40] },
];

let speed = 10;

let cups = Array.from({length:3}, (_,i)=>({ id:`cup-${i+1}`, labelId:null, water:0, sugar:0, dissolved:false }));
let plates = Array.from({length:3}, (_,i)=>({ id:`plate-${i+1}`, labelId:null, solutionWater:0, solutionSugar:0, mmColorId:null, simTime:0, running:false }));

// six movable label chips (3 for cups, 3 for plates)
let labelChips = [
  { chipId:"no-cup",   labelId:"no",   text:"No sugar",     target:"cup",   location:{type:"tray"} },
  { chipId:"1tsp-cup", labelId:"1tsp", text:"1 tsp sugar",  target:"cup",   location:{type:"tray"} },
  { chipId:"3tsp-cup", labelId:"3tsp", text:"3 tsp sugar",  target:"cup",   location:{type:"tray"} },
  { chipId:"no-plate",   labelId:"no",   text:"No sugar",   target:"plate", location:{type:"tray"} },
  { chipId:"1tsp-plate", labelId:"1tsp", text:"1 tsp sugar",target:"plate", location:{type:"tray"} },
  { chipId:"3tsp-plate", labelId:"3tsp", text:"3 tsp sugar",target:"plate", location:{type:"tray"} },
];

/* ----------------------------- Helpers ----------------------------- */
const $ = sel => document.querySelector(sel);
function el(tag, props={}, ...children){
  const d = document.createElement(tag);
  for(const [k,v] of Object.entries(props)){
    if(k==="style" && typeof v==="object"){ Object.assign(d.style, v); }
    else if(k.startsWith("on") && typeof v==="function"){ d.addEventListener(k.slice(2).toLowerCase(), v); }
    else if(k==="dataset"){ Object.assign(d.dataset, v); }
    else if(v!==false && v!=null){ d.setAttribute(k, v===true ? "" : v); }
  }
  for(const c of children){ d.append(c && c.nodeType ? c : document.createTextNode(c ?? "")); }
  return d;
}
function toast(msg){
  const t = $("#toast"); t.textContent = msg; t.style.display = "block";
  clearTimeout(toast._t); toast._t = setTimeout(()=> t.style.display = "none", 2200);
}
function dataPayload(e){ try { return JSON.parse(e.dataTransfer.getData("application/json")); } catch { return null; } }
function onDragStart(e, payload){
  e.dataTransfer.setData("application/json", JSON.stringify(payload));
  const g = document.createElement("div"); g.className="pill ghost"; g.style.position="fixed"; g.style.top="-1000px";
  g.textContent = payload.previewText || "Drag"; document.body.appendChild(g); e.dataTransfer.setDragImage(g, 10, 10);
  setTimeout(()=>document.body.removeChild(g),0);
}
const labelText = id => (LABELS.find(l=>l.id===id)||{}).text || "—";

/* ----------------------------- Build UI ----------------------------- */
function buildEverything(){
  buildSteps();
  buildTools();
  buildBoards();
}
function buildSteps(){
  const st = $("#steps");
  const ok = (b)=> b ? "ok" : "";
  const done = (b)=> b ? "done" : "";
  const status = computeStatus();
  st.innerHTML="";
  const steps = [
    {text:"Label 3 cups + 3 plates (No sugar, 1 tsp sugar, 3 tsp sugar)", ok:status.labelsDone},
    {text:"Add ¼ cup water to each cup", ok:status.waterDone},
    {text:"Add sugar to the 1-tsp and 3-tsp cups", ok:status.sugarDone},
    {text:"Stir until sugar dissolves", ok:status.dissolvedDone},
    {text:"Pour each cup into its matching plate", ok:status.pouredDone},
    {text:"Add an M&M to each plate; watch and record observations", ok:status.mmPlaced},
  ];
  steps.forEach((s,i)=>{
    const li = el("li",{class:`${s.ok?'done':''}`},
      el("span",{class:`n ${ok(s.ok)}`}, String(i+1)), " ",
      el("span",{}, s.text)
    );
    if(s.ok){ li.classList.add("done"); }
    st.append(li);
  });
}
function buildTools(){
  // Tools drag sources
  $("#tool-water").addEventListener("dragstart", e=> onDragStart(e,{type:"water", previewText:"¼ cup water"}));
  $("#tool-sugar").addEventListener("dragstart", e=> onDragStart(e,{type:"sugar", amount:1, previewText:"+1 tsp sugar"}));
  const mmTray = $("#mmTray"); mmTray.innerHTML="";
  MM.forEach(m=>{
    const dot = el("span",{class:"circle", draggable:true, ondragstart:(e)=>onDragStart(e,{type:"mm", mmColorId:m.id, previewText:`M&M`}),
      style:{background:`rgb(${m.rgb[0]},${m.rgb[1]},${m.rgb[2]})`}});
    mmTray.append(dot);
  });

  // Label tray (also a drop target to return labels)
  const tray = $("#labelTray"); tray.innerHTML="";
  tray.addEventListener("dragover", e=>e.preventDefault());
  tray.addEventListener("drop", e=>{
    const p = dataPayload(e); if(!p) return;
    if(p.type==="labelChip"){
      const chip = labelChips.find(c=>c.chipId===p.chipId); if(!chip) return;
      if(chip.location.type==="cup"){
        const cup = cups.find(x=>x.id===chip.location.id);
        if(cup && cup.labelId===chip.labelId) cup.labelId=null;
      } else if(chip.location.type==="plate"){
        const plate = plates.find(x=>x.id===chip.location.id);
        if(plate && plate.labelId===chip.labelId) plate.labelId=null;
      }
      chip.location={type:"tray"};
      buildEverything();
    }
  });
  labelChips.filter(c=>c.location.type==="tray").forEach(ch=>{
    tray.append(
      el("div",{class:"pill",draggable:true,
        ondragstart:(e)=>onDragStart(e,{type:"labelChip", chipId:ch.chipId, labelId:ch.labelId, target:ch.target, previewText:`${ch.text} (${ch.target})`})
      }, ch.text," ",el("span",{class:"tiny"}, `(${ch.target})`))
    );
  });

  // Speed + Reset
  $("#speed").oninput = (e)=>{ speed = parseInt(e.target.value||"10",10); $("#speedLabel").textContent = `${speed}×`; };
  $("#resetAll").onclick = ()=>{ resetAll(); };
}
function cupCard(c){
  const head = el("div",{class:"flex",style:{justifyContent:"space-between"}},
    el("span",{class:"tiny"}, c.id),
    el("div",{class:"pill",draggable:true,title:"Drag this cup onto a matching plate to pour",
      ondragstart:(e)=>onDragStart(e,{type:"cup", cupId:c.id, previewText:c.id})},"Drag to pour")
  );
  const labelLine = el("div",{}, el("strong",{},"Label:")," ", el("span",{}, labelText(c.labelId)));
  const attachedWrap = el("div",{class:"attached"});
  const attachedChip = labelChips.find(ch=>ch.location.type==="cup" && ch.location.id===c.id);
  if(attachedChip){
    attachedWrap.append(
      el("div",{class:"pill",draggable:true,
        ondragstart:(e)=>onDragStart(e,{type:"labelChip", chipId:attachedChip.chipId, labelId:attachedChip.labelId, target:"cup", previewText:attachedChip.text+" (cup)"})
      }, attachedChip.text, " ", el("span",{class:"tiny"},"(cup)"))
    );
  } else {
    attachedWrap.append(el("span",{class:"tiny",style:{color:"#94a3b8"}},"Drop a CUP label here"));
  }

  const state = el("div",{},
    el("div",{}, el("strong",{},"Water:")," ", el("span",{}, `${c.water.toFixed(2)} cup`)),
    el("div",{}, el("strong",{},"Sugar:")," ", el("span",{}, `${c.sugar} tsp`)," ",
      c.sugar>0?el("span",{class:"badge badge-amber"}, c.dissolved?"dissolved":"undissolved"):"")
  );
  const vis = el("div",{class:"cupVis"}); drawCupVis(vis,c);
  const foot = el("div",{class:"flex"},
    el("span",{class:"pill tiny"},"Drop: water / sugar / CUP label"),
    el("button",{class:"btn",onclick:()=>stirCup(c.id)},"Stir")
  );

  const box = el("div",{class:"slot",
    ondragover:(e)=>e.preventDefault(),
    ondrop:(e)=>{
      const p = dataPayload(e); if(!p) return;
      if(p.type==="labelChip" && p.target==="cup"){ attachLabelChipToCup(p.chipId, c.id); return; }
      if(p.type==="water"){ const w=Math.min(0.25, +(c.water+0.25).toFixed(2)); setCup(c.id,{water:w}); return; }
      if(p.type==="sugar"){ setCup(c.id,{sugar:c.sugar+1, dissolved:false}); return; }
    }
  });
  box.append(head,labelLine,attachedWrap,state,foot,vis);
  return box;
}
function plateCard(p){
  const head = el("div",{class:"flex",style:{justifyContent:"space-between"}},
    el("span",{class:"tiny"}, p.id),
    el("span",{class:"tiny pill"},"Drop: label / CUP / M&M")
  );
  const labelLine = el("div",{}, el("strong",{},"Label:")," ", el("span",{}, labelText(p.labelId)));
  const attachedWrap = el("div",{class:"attached"});
  const attachedChip = labelChips.find(ch=>ch.location.type==="plate" && ch.location.id===p.id);
  if(attachedChip){
    attachedWrap.append(
      el("div",{class:"pill",draggable:true,
        ondragstart:(e)=>onDragStart(e,{type:"labelChip", chipId:attachedChip.chipId, labelId:attachedChip.labelId, target:"plate", previewText:attachedChip.text+" (plate)"})
      }, attachedChip.text, " ", el("span",{class:"tiny"},"(plate)"))
    );
  } else {
    attachedWrap.append(el("span",{class:"tiny",style:{color:"#94a3b8"}},"Drop a PLATE label here"));
  }
  const state = el("div",{},
    el("div",{}, el("strong",{},"Solution:")," ", el("span",{}, `${p.solutionWater.toFixed(2)} cup`)),
    el("div",{}, el("strong",{},"Sugar:")," ", el("span",{}, `${p.solutionSugar} tsp`)),
    el("div",{}, el("strong",{},"M&M:")," ", el("span",{}, p.mmColorId || "—"))
  );
  const vis = el("div",{class:"plateVis"}); drawPlateVis(vis,p);
  const foot = el("div",{class:"flex"},
    el("button",{class:"btn",style:{marginLeft:"auto"},onclick:()=>resetPlate(p.id)},"Reset plate")
  );

  const box = el("div",{class:"slot",
    ondragover:(e)=>e.preventDefault(),
    ondrop:(e)=>{
      const pld = dataPayload(e); if(!pld) return;
      if(pld.type==="labelChip" && pld.target==="plate"){ attachLabelChipToPlate(pld.chipId, p.id); return; }
      if(pld.type==="cup"){ onCupPoured(pld.cupId, p.id); return; }
      if(pld.type==="mm"){ onMMDropped(p.id, pld.mmColorId); return; }
    }
  });
  box.append(head,labelLine,attachedWrap,state,vis,foot);
  return box;
}
function buildBoards(){
  const cupsWrap = $("#cups"); cupsWrap.innerHTML="";
  cups.forEach(c=> cupsWrap.append(cupCard(c)));
  const platesWrap = $("#plates"); platesWrap.innerHTML="";
  plates.forEach(p=> platesWrap.append(plateCard(p)));
}

/* ----------------------------- Mutations ----------------------------- */
function setCup(id, patch){ cups = cups.map(c=> c.id===id?{...c,...patch}:c); buildEverything(); }
function setPlate(id, patch){ plates = plates.map(p=> p.id===id?{...p,...patch}:p); buildEverything(); }
function attachLabelChipToCup(chipId, cupId){
  const chip = labelChips.find(c=>c.chipId===chipId); if(!chip) return;
  // detach old location
  if(chip.location.type==="cup"){
    const cupPrev = cups.find(x=>x.id===chip.location.id);
    if(cupPrev && cupPrev.labelId===chip.labelId) cupPrev.labelId=null;
  }
  chip.location={type:"cup", id:cupId};
  const cup = cups.find(c=>c.id===cupId); if(cup) cup.labelId = chip.labelId;
  buildEverything();
}
function attachLabelChipToPlate(chipId, plateId){
  const chip = labelChips.find(c=>c.chipId===chipId); if(!chip) return;
  if(chip.location.type==="plate"){
    const plPrev = plates.find(x=>x.id===chip.location.id);
    if(plPrev && plPrev.labelId===chip.labelId) plPrev.labelId=null;
  }
  chip.location={type:"plate", id:plateId};
  const pl = plates.find(p=>p.id===plateId); if(pl) pl.labelId = chip.labelId;
  buildEverything();
}
function stirCup(cupId){
  const c = cups.find(x=>x.id===cupId);
  if(!c) return;
  if(c.water<=0) return toast("Add water first (¼ cup).");
  if(c.sugar<=0) return toast("No sugar to dissolve in this cup.");
  toast("Stirring… dissolving sugar");
  setTimeout(()=>{
    setCup(cupId,{dissolved:true});
    toast("Sugar dissolved!");
  }, Math.max(600, 800 + c.sugar*300));
}
function onCupPoured(cupId, plateId){
  const cup = cups.find(c=>c.id===cupId); const plate = plates.find(p=>p.id===plateId);
  if(!cup || !plate) return;
  if(!cup.labelId) return toast("Label the cup before pouring.");
  if(!plate.labelId) return toast("Label the plate before pouring.");
  if(plate.labelId !== cup.labelId) return toast("Pour into the matching labeled plate.");
  if(cup.water<=0) return toast("This cup is empty — add water.");
  if(cup.sugar>0 && !cup.dissolved) return toast("Stir until sugar dissolves before pouring.");

  setPlate(plateId,{
    solutionWater: +(plate.solutionWater + cup.water).toFixed(2),
    solutionSugar: plate.solutionSugar + cup.sugar
  });
  setCup(cupId,{water:0,sugar:0,dissolved:false});
  toast("Poured into plate.");
}
function onMMDropped(plateId, colorId){
  const plate = plates.find(p=>p.id===plateId); if(!plate) return;
  if(plate.solutionWater<=0) return toast("Pour the solution into this plate first.");
  setPlate(plateId,{ mmColorId:colorId, running:true, simTime:0 });
}
function resetPlate(id){ setPlate(id,{mmColorId:null, simTime:0, running:false}); }
function resetAll(){
  cups = Array.from({length:3},(_,i)=>({id:`cup-${i+1}`,labelId:null,water:0,sugar:0,dissolved:false}));
  plates = Array.from({length:3},(_,i)=>({id:`plate-${i+1}`,labelId:null,solutionWater:0,solutionSugar:0,mmColorId:null,simTime:0,running:false}));
  labelChips.forEach(ch=> ch.location={type:"tray"});
  speed = 10; $("#speed").value = "10"; $("#speedLabel").textContent = "10×";
  buildEverything();
  toast("Reset the lab.");
}

/* ----------------------------- Visuals ----------------------------- */
function drawCupVis(root, c){
  root.innerHTML="";
  const box = el("div",{style:{width:"90%",height:"90%",border:"1px solid #cbd5e1",borderRadius:"12px",position:"relative",overflow:"hidden",background:"#f8fafc"}});
  const water = el("div",{style:{position:"absolute",left:"0",right:"0",bottom:"0",height:(Math.min(1,c.water/0.25)*100)+"%",background:"linear-gradient(to top, rgba(56,189,248,0.35), rgba(56,189,248,0.2))",transition:"height .2s"}});
  box.append(water);
  if(c.sugar>0){
    box.append(el("div",{style:{position:"absolute",left:"6px",bottom:"6px",fontSize:"10px",background:"#fde68a",color:"#92400e",border:"1px solid #f59e0b",borderRadius:"8px",padding:"2px 6px"}},
      c.dissolved?"Sugar dissolved":"Sugar crystals"));
  }
  root.append(box);
}
function drawPlateVis(root, p){
  root.innerHTML="";
  const wrap = el("div",{style:{width:"232px",height:"232px",display:"grid",placeItems:"center"}});
  const canvas = el("canvas",{width:232,height:232,style:{border:"1px solid #cbd5e1",borderRadius:"12px",background:"#fff"}});
  wrap.append(canvas); root.append(wrap);
  const ctx = canvas.getContext("2d");
  const cx = canvas.width/2, cy = canvas.height/2, radius = canvas.width/2 - 10;

  // background water tint
  if(p.solutionWater>0){
    ctx.fillStyle = "rgba(56,189,248,0.15)";
    ctx.beginPath(); ctx.arc(cx,cy,radius,0,Math.PI*2); ctx.fill();
  }
  // M&M center dot
  ctx.fillStyle = p.mmColorId ? mmColorToCss(p.mmColorId) : "#e2e8f0";
  ctx.beginPath(); ctx.arc(cx,cy,10,0,Math.PI*2); ctx.fill();

  // diffusion gradient
  if(p.mmColorId){
    const sugar = p.solutionSugar;
    const k = 8;
    const r = Math.min(radius, k*Math.sqrt(Math.max(0,p.simTime))/(1+0.6*sugar));
    const softness = Math.max(6, 22 - sugar*6);

    const grad = ctx.createRadialGradient(cx,cy,Math.max(0,r-softness), cx,cy,Math.max(0,r+softness));
    const [R,G,B] = MM.find(m=>m.id===p.mmColorId).rgb;
    grad.addColorStop(0, `rgba(${R},${G},${B},0.85)`);
    grad.addColorStop(Math.max(0,(r/(r+softness))), `rgba(${R},${G},${B},0.5)`);
    grad.addColorStop(1, `rgba(${R},${G},${B},0.0)`);
    ctx.fillStyle = grad;
    ctx.beginPath(); ctx.arc(cx,cy,Math.max(0,r+softness),0,Math.PI*2); ctx.fill();

    // dashed ring
    ctx.strokeStyle="#94a3b8"; ctx.setLineDash([4,4]); ctx.lineWidth=1;
    ctx.beginPath(); ctx.arc(cx,cy,radius,0,Math.PI*2); ctx.stroke();
  }
}
function mmColorToCss(id){ const m=MM.find(x=>x.id===id); return `rgb(${m.rgb[0]},${m.rgb[1]},${m.rgb[2]})`; }

/* ----------------------------- Simulation Loop ----------------------------- */
setInterval(()=>{
  let changed = false;
  plates = plates.map(pl=>{
    if(!pl.running) return pl;
    const next = {...pl, simTime: pl.simTime + 0.1*speed};
    changed = true; return next;
  });
  if(changed){ // redraw plates only
    buildSteps();
    const platesWrap = $("#plates"); platesWrap.innerHTML="";
    plates.forEach(p=> platesWrap.append(plateCard(p)));
  }
},100);

/* ----------------------------- Init ----------------------------- */
document.addEventListener("dragstart", e=>{
  // prevent text selection ghost image on some browsers
  if(e.target.classList && e.target.classList.contains("pill")) e.target.style.opacity="0.8";
});
document.addEventListener("dragend", e=>{
  if(e.target.classList && e.target.classList.contains("pill")) e.target.style.opacity="";
});
$("#speed").dispatchEvent(new Event("input"));

buildEverything();
</script>
</body>
</html>
